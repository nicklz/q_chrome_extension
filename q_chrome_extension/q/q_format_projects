#!/usr/bin/env bash

# ðŸŸ¢ AUTO FORMAT SCRIPT â€“ Business/Creative Projects Formatter with VENV Resilience

ENV_FILE="$(dirname "$0")/../.env"
if [ -f "$ENV_FILE" ]; then
    export $(grep -v '^#' "$ENV_FILE" | xargs)
fi

if [ -z "$INSTALL_PATH" ]; then
    echo "ðŸ”´ Error: INSTALL_PATH is not set in .env"
    exit 1
fi

PYTHON_SCRIPT="$INSTALL_PATH/q/format_files.py"
TARGET_DIR="${1:-.}"
VENV_DIR="$INSTALL_PATH/venv"

echo -e "ðŸŸ¢ [START] Auto-formatting process for directory: $TARGET_DIR\n"

# ðŸŸ¡ Step 1: Ensure virtual environment exists and is valid
if [ ! -f "$VENV_DIR/bin/activate" ]; then
    echo -e "ðŸŸ¡ [VENV] venv invalid or missing. Recreating at $VENV_DIR"
    rm -rf "$VENV_DIR"
    python3 -m venv "$VENV_DIR"
    if [ ! -f "$VENV_DIR/bin/activate" ]; then
        echo "ðŸ”´ Failed to create virtual environment (activate script still missing)"
        exit 1
    fi
fi


# ðŸŸ¡ Step 2: Activate the virtual environment
VENV_ACTIVATE="$VENV_DIR/bin/activate"
if [ ! -f "$VENV_ACTIVATE" ]; then
    echo "ðŸ”´ Virtual environment activation script not found at $VENV_ACTIVATE"
    exit 1
fi

source "$VENV_ACTIVATE"
if [ $? -ne 0 ]; then
    echo "ðŸ”´ Failed to activate Python venv at $VENV_DIR"
    exit 1
fi
echo -e "ðŸŸ¢ [VENV] Activated virtual environment."

# ðŸŸ¡ Step 3: Ensure required packages are installed
REQUIRED_PKGS=(openai python-dotenv)
for pkg in "${REQUIRED_PKGS[@]}"; do
    pip show "$pkg" &>/dev/null
    if [ $? -ne 0 ]; then
        echo -e "ðŸŸ¡ [VENV] Installing missing package: $pkg"
        pip install --upgrade pip
        pip install "$pkg"
    fi
done

# ðŸŸ¡ Step 4: Process all .txt files in directory
find "$TARGET_DIR" -maxdepth 1 -type f -name '*.txt' -print0 | while IFS= read -r -d '' file; do
    echo -e "ðŸŸ¡ [THREAD START] Processing: $file"
    python "$PYTHON_SCRIPT" "$file"
    echo -e "ðŸŸ¢ [THREAD COMPLETE] $file\n"
done

# ðŸŸ¢ Step 5: Deactivate venv and exit cleanly
deactivate
echo -e "ðŸŸ¢ðŸŸ¢ðŸŸ¢ [ALL COMPLETED] All .txt files have been normalized and structured."
